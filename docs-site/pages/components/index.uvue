<template>
  <doc-layout :sidebar-groups="sidebarGroups" :show-sidebar="true" :show-toc="false">
    <view class="components-content">
      <view class="page-header">
        <text class="page-title">ÁªÑ‰ª∂Á¥¢Âºï</text>
        <text class="page-description">Belay-Unix ÁªÑ‰ª∂Â∫ìÊèê‰æõ‰∫Ü 107+ ‰∏™È´òË¥®ÈáèÁªÑ‰ª∂ÔºåË¶ÜÁõñÂü∫Á°Ä„ÄÅË°®Âçï„ÄÅÂèçÈ¶à„ÄÅÂ±ïÁ§∫„ÄÅÂØºËà™Á≠âÂú∫ÊôØ„ÄÇ</text>
      </view>
      
      <view class="content">
        <!-- ÁõÆÂΩïÂØºËà™ -->
        <view class="toc-section">
          <text class="toc-title">üìã ÁõÆÂΩï</text>
          <view class="toc-links">
            <text 
              v-for="category in categories" 
              :key="category.id"
              class="toc-link"
              @click="scrollToCategory(category.id)"
            >
              {{ category.name }}
            </text>
          </view>
        </view>

        <!-- ÁªÑ‰ª∂ÂàÜÁ±ª -->
        <view 
          class="category-section" 
          v-for="category in categories" 
          :key="category.id"
          :id="category.id"
        >
          <view class="category-header">
            <text class="category-title">
              <text class="category-icon">{{ category.icon }}</text>
              {{ category.name }}Ôºà{{ category.components.length }}‰∏™Ôºâ
            </text>
            <text class="category-desc">{{ category.description }}</text>
          </view>
          
          <view class="component-list">
            <view 
              class="component-item"
              v-for="component in category.components"
              :key="component.name"
            >
              <view class="component-info">
                <text class="component-name">{{ component.name }}</text>
                <text class="component-desc">{{ component.description || formatComponentName(component.name) }}</text>
              </view>
              <button class="view-btn" @click="goToDetail(component.name)">Êü•ÁúãÊñáÊ°£</button>
            </view>
          </view>
        </view>

        <!-- ÁªÑ‰ª∂ÁªüËÆ° -->
        <view class="stats-section">
          <text class="section-title">üìä ÁªÑ‰ª∂ÁªüËÆ°</text>
          <view class="stats-list">
            <view class="stats-item" v-for="category in categories" :key="category.id">
              <text class="stats-label">{{ category.name }}</text>
              <text class="stats-value">{{ category.components.length }}</text>
            </view>
            <view class="stats-item total-row">
              <text class="stats-label">ÊÄªËÆ°</text>
              <text class="stats-value">{{ totalComponents }}</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </doc-layout>
</template>

<script setup lang="uts">
import { ref, computed, onMounted } from 'vue'
import { getAllComponents, componentCategories, type ComponentDoc } from '@/utils/doc-loader'
import { componentsSidebar, type SidebarGroup } from '@/utils/sidebar-config'

const sidebarGroups = computed(() => {
  return componentsSidebar
})

const allComponents = ref<ComponentDoc[]>([])
const categories = computed(() => {
  const cats = [
    { 
      id: 'basic', 
      name: 'Âü∫Á°ÄÁªÑ‰ª∂', 
      icon: 'üé®',
      description: 'Âü∫Á°ÄÁªÑ‰ª∂ÊòØÊûÑÂª∫Â∫îÁî®ÁöÑÂü∫Á°ÄÔºåÊèê‰æõÊúÄÂ∏∏Áî®ÁöÑ UI ÂÖÉÁ¥†„ÄÇ',
      components: [] as ComponentDoc[]
    },
    { 
      id: 'form', 
      name: 'Ë°®ÂçïÁªÑ‰ª∂', 
      icon: 'üìù',
      description: 'Ë°®ÂçïÁªÑ‰ª∂Áî®‰∫éÊï∞ÊçÆËæìÂÖ•ÂíåÁî®Êà∑‰∫§‰∫í„ÄÇ',
      components: [] as ComponentDoc[]
    },
    { 
      id: 'feedback', 
      name: 'ÂèçÈ¶àÁªÑ‰ª∂', 
      icon: 'üí¨',
      description: 'ÂèçÈ¶àÁªÑ‰ª∂Áî®‰∫éÂêëÁî®Êà∑Â±ïÁ§∫Êìç‰ΩúÁªìÊûúÂíåÁä∂ÊÄÅ„ÄÇ',
      components: [] as ComponentDoc[]
    },
    { 
      id: 'display', 
      name: 'Â±ïÁ§∫ÁªÑ‰ª∂', 
      icon: 'üé≠',
      description: 'Â±ïÁ§∫ÁªÑ‰ª∂Áî®‰∫éÂ±ïÁ§∫Êï∞ÊçÆÂíå‰ø°ÊÅØ„ÄÇ',
      components: [] as ComponentDoc[]
    },
    { 
      id: 'navigation', 
      name: 'ÂØºËà™ÁªÑ‰ª∂', 
      icon: 'üß≠',
      description: 'ÂØºËà™ÁªÑ‰ª∂Áî®‰∫éÈ°µÈù¢ÂØºËà™ÂíåË∑ØÁî±„ÄÇ',
      components: [] as ComponentDoc[]
    },
    { 
      id: 'layout', 
      name: 'Â∏ÉÂ±ÄÁªÑ‰ª∂', 
      icon: 'üìê',
      description: 'Â∏ÉÂ±ÄÁªÑ‰ª∂Áî®‰∫éÈ°µÈù¢Â∏ÉÂ±ÄÂíåÁªìÊûÑ„ÄÇ',
      components: [] as ComponentDoc[]
    },
    { 
      id: 'other', 
      name: 'ÂÖ∂‰ªñÁªÑ‰ª∂', 
      icon: 'üîß',
      description: 'ÂÖ∂‰ªñÂäüËÉΩÁªÑ‰ª∂ÂíåÂ∑•ÂÖ∑ÁªÑ‰ª∂„ÄÇ',
      components: [] as ComponentDoc[]
    }
  ]

  // ÊåâÂàÜÁ±ªÂàÜÁªÑÁªÑ‰ª∂
  allComponents.value.forEach(component => {
    const catMap: Record<string, string> = {
      'Âü∫Á°ÄÁªÑ‰ª∂': 'basic',
      'Ë°®ÂçïÁªÑ‰ª∂': 'form',
      'ÂèçÈ¶àÁªÑ‰ª∂': 'feedback',
      'Â±ïÁ§∫ÁªÑ‰ª∂': 'display',
      'ÂØºËà™ÁªÑ‰ª∂': 'navigation',
      'Â∏ÉÂ±ÄÁªÑ‰ª∂': 'layout',
      'ÂÖ∂‰ªñÁªÑ‰ª∂': 'other'
    }
    const catId = catMap[component.category]
    const catIndex = cats.findIndex(cat => cat.id === catId)
    if (catIndex != -1) {
      cats[catIndex].components.push(component)
    }
  })

  return cats
})

const totalComponents = computed(() => {
  return categories.value.reduce((sum, cat) => sum + cat.components.length, 0)
})

onMounted(() => {
  allComponents.value = getAllComponents()
  
  // Â¶ÇÊûúÊúâÂàÜÁ±ªÂèÇÊï∞ÔºåÊªöÂä®Âà∞ÂØπÂ∫îÂàÜÁ±ª
  // #ifdef APP || H5
  const pages = getCurrentPages()
  if (pages != null && pages.length > 0) {
    const currentPage = pages[pages.length - 1]
    const options = currentPage.options || {}
    const category = options.category as string
    if (category) {
      const catMap: Record<string, string> = {
        'Âü∫Á°ÄÁªÑ‰ª∂': 'basic',
        'Ë°®ÂçïÁªÑ‰ª∂': 'form',
        'ÂèçÈ¶àÁªÑ‰ª∂': 'feedback',
        'Â±ïÁ§∫ÁªÑ‰ª∂': 'display',
        'ÂØºËà™ÁªÑ‰ª∂': 'navigation',
        'Â∏ÉÂ±ÄÁªÑ‰ª∂': 'layout',
        'ÂÖ∂‰ªñÁªÑ‰ª∂': 'other'
      }
      const catId = catMap[category]
      if (catId) {
        setTimeout(() => scrollToCategory(catId), 100)
      }
    }
  }
  // #endif
})

const formatComponentName = (name: string): string => {
  return name.replace('bl-', '').replace(/-/g, ' ')
}

const scrollToCategory = (id: string) => {
  // uni-app ‰∏≠ÈúÄË¶Å‰ΩøÁî® uni.createSelectorQuery Êù•ÊªöÂä®
  uni.createSelectorQuery().select(`#${id}`).boundingClientRect((data: any) => {
    if (data) {
      uni.pageScrollTo({
        scrollTop: data.top,
        duration: 300
      })
    }
  }).exec()
}

const goToDetail = (componentName: string) => {
  uni.navigateTo({
    url: `/pages/component-detail/index?name=${encodeURIComponent(componentName)}`
  })
}
</script>

<style lang="scss">
@import '@/styles/variables.scss';

.components-content {
  width: 100%;
}

.page-header {
  margin-bottom: $vp-spacing-xl;
}

.page-title {
  font-size: $vp-font-size-3xl;
  font-weight: $vp-font-weight-semibold;
  color: $vp-c-text-1;
  margin-bottom: $vp-spacing-sm;
  display: block;
}

.page-description {
  font-size: $vp-font-size-base;
  color: $vp-c-text-2;
  line-height: 1.7;
  display: block;
}

.content {
  width: 100%;
}

.toc-section {
  background: $vp-c-bg;
  padding: $vp-spacing-lg;
  border-radius: $vp-border-radius-lg;
  margin-bottom: $vp-spacing-xl;
  border: 1px solid $vp-c-divider;
}

.toc-title {
  font-size: $vp-font-size-xl;
  font-weight: $vp-font-weight-semibold;
  color: $vp-c-text-1;
  margin-bottom: $vp-spacing-md;
  display: block;
}

.toc-links {
  display: flex;
  flex-direction: row;
  flex-wrap: wrap;
  gap: $vp-spacing-sm;
}

.toc-link {
  color: $vp-c-brand;
  padding: $vp-spacing-xs $vp-spacing-sm;
  border-radius: $vp-border-radius-sm;
  font-size: $vp-font-size-sm;
  transition: all $vp-transition-base;
  /* #ifdef H5 */
  cursor: pointer;
  &:hover {
    background: $vp-c-bg-soft;
  }
  /* #endif */
}

.category-section {
  background: $vp-c-bg;
  padding: $vp-spacing-xl;
  border-radius: $vp-border-radius-lg;
  margin-bottom: $vp-spacing-xl;
  border: 1px solid $vp-c-divider;
}

.category-header {
  margin-bottom: $vp-spacing-lg;
}

.category-title {
  font-size: $vp-font-size-2xl;
  font-weight: $vp-font-weight-semibold;
  color: $vp-c-text-1;
  margin-bottom: $vp-spacing-sm;
  display: block;
}

.category-icon {
  margin-right: $vp-spacing-sm;
}

.category-desc {
  font-size: $vp-font-size-sm;
  color: $vp-c-text-2;
  line-height: 1.6;
  display: block;
}

.component-list {
  display: flex;
  flex-direction: column;
  gap: $vp-spacing-sm;
}

.component-item {
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: space-between;
  padding: $vp-spacing-md;
  border-bottom: 1px solid $vp-c-divider;
  transition: background-color $vp-transition-base;
  /* #ifdef H5 */
  &:hover {
    background-color: $vp-c-bg-soft;
  }
  /* #endif */
}

.component-info {
  display: flex;
  flex-direction: column;
  flex: 1;
}

.component-name {
  background: $vp-c-bg-soft;
  padding: $vp-spacing-xs $vp-spacing-sm;
  border-radius: $vp-border-radius-sm;
  font-family: 'Monaco', 'Courier New', monospace;
  font-size: $vp-font-size-xs;
  color: #e83e8c;
  margin-bottom: $vp-spacing-sm;
  display: inline-block;
}

.component-desc {
  font-size: $vp-font-size-sm;
  color: $vp-c-text-2;
  display: block;
}

.view-btn {
  padding: $vp-spacing-xs $vp-spacing-md;
  background: $vp-c-brand;
  color: #ffffff;
  border: none;
  border-radius: $vp-border-radius-sm;
  font-size: $vp-font-size-sm;
  transition: all $vp-transition-base;
  /* #ifdef H5 */
  cursor: pointer;
  &:hover {
    background: $vp-c-brand-light;
  }
  /* #endif */
}

.stats-section {
  background: $vp-c-bg;
  padding: $vp-spacing-xl;
  border-radius: $vp-border-radius-lg;
  margin-bottom: $vp-spacing-xl;
  border: 1px solid $vp-c-divider;
}

.section-title {
  font-size: $vp-font-size-2xl;
  font-weight: $vp-font-weight-semibold;
  color: $vp-c-text-1;
  margin-bottom: $vp-spacing-lg;
  display: block;
}

.stats-list {
  display: flex;
  flex-direction: column;
  gap: $vp-spacing-sm;
}

.stats-item {
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  padding: $vp-spacing-sm $vp-spacing-md;
  border-bottom: 1px solid $vp-c-divider;
}

.total-row {
  background: $vp-c-bg-soft;
  font-weight: $vp-font-weight-semibold;
}

.stats-label {
  font-size: $vp-font-size-sm;
  color: $vp-c-text-1;
}

.stats-value {
  font-size: $vp-font-size-sm;
  color: $vp-c-text-1;
}
</style>

